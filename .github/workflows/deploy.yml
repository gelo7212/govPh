name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment to deploy'
        required: true
        default: 'PILOT'
        type: choice
        options:
          - DEV
          - PILOT
          - PROD
      service:
        description: 'Choose service to deploy'
        required: true
        default: 'ALL'
        type: choice
        options:
          - ALL
          - nginx
          - kong
          - bff-citizen
          - bff-admin
          - sos-service
          - identity-service
          - geo-service
          - realtime-service
          - incident-service
          - city-service

jobs:
  deploy:
    runs-on: self-hosted
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up environment variables
      id: set-env
      run: |
        ENV="${{ github.event.inputs.environment }}"
        SERVICE="${{ github.event.inputs.service }}"

        if [ "$SERVICE" = "ALL" ]; then
          SERVICE=""
        fi

        echo "COMPOSE_FILE=docker-compose.${ENV,,}.yml" >> $GITHUB_ENV
        echo "PROJECT_NAME=ecitizen-${ENV,,}" >> $GITHUB_ENV
        echo "SERVICE=$SERVICE" >> $GITHUB_ENV

    - name: Create .env file
      env:
        LIGHTSAIL_HOST_PROD: ${{ secrets.LIGHTSAIL_HOST_PROD }}
        MONGODB_URI_PROD: ${{ secrets.MONGODB_URI_PROD }}
        LIGHTSAIL_HOST_DEV: ${{ secrets.LIGHTSAIL_HOST_DEV }}
        MONGODB_URI_DEV: ${{ secrets.MONGODB_URI_DEV }}
        CORS_ORIGIN: ${{ vars.CORS_ORIGIN }}
        INVITE_LINK_HOST: ${{ vars.INVITE_LINK_HOST }}
        JWT_PUBLIC_KEY: ${{ vars.JWT_PUBLIC_KEY }}
        LOG_LEVEL: ${{ vars.LOG_LEVEL }}
        MONGODB_POOL_SIZE: ${{ vars.MONGODB_POOL_SIZE }}
        REDIS_DB: ${{ vars.REDIS_DB }}
        REDIS_PORT: ${{ vars.REDIS_PORT }}
        SEMAPHORE_API_URL: ${{ vars.SEMAPHORE_API_URL }}
        TOKEN_REVOCATION_CACHE_TTL: ${{ vars.TOKEN_REVOCATION_CACHE_TTL }}
        TOKEN_REVOCATION_ENABLED: ${{ vars.TOKEN_REVOCATION_ENABLED }}
        CITY_SERVICE_DB_NAME: ${{ secrets.CITY_SERVICE_DB_NAME }}
        CITY_SERVICE_MONGODB_URI: ${{ secrets.CITY_SERVICE_MONGODB_URI }}
        CITY_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.CITY_SERVICE_MONGODB_URI_OPTIONS }}
        CLIENT_ID_ADMIN: ${{ secrets.CLIENT_ID_ADMIN }}
        CLIENT_ID_RESCUE: ${{ secrets.CLIENT_ID_RESCUE }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        FIREBASE_ADMIN_SDK_KEY: ${{ secrets.FIREBASE_ADMIN_SDK_KEY }}
        GEO_SERVICE_DB_NAME: ${{ secrets.GEO_SERVICE_DB_NAME }}
        GEO_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.GEO_SERVICE_MONGODB_URI_OPTIONS }}
        IDENTITY_SERVICE_DB_NAME: ${{ secrets.IDENTITY_SERVICE_DB_NAME }}
        IDENTITY_SERVICE_MONGODB_URI: ${{ secrets.IDENTITY_SERVICE_MONGODB_URI }}
        IDENTITY_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.IDENTITY_SERVICE_MONGODB_URI_OPTIONS }}
        INCIDENT_DB_NAME: ${{ secrets.INCIDENT_DB_NAME }}
        INCIDENT_MONGODB_URI: ${{ secrets.INCIDENT_MONGODB_URI }}
        INCIDENT_MONGODB_URI_OPTIONS: ${{ secrets.INCIDENT_MONGODB_URI_OPTIONS }}
        INTERNAL_AUTH_TOKEN: ${{ secrets.INTERNAL_AUTH_TOKEN }}
        JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
        JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
        OTP_SECRET: ${{ secrets.OTP_SECRET }}
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        SEMAPHORE_API_KEY: ${{ secrets.SEMAPHORE_API_KEY }}
        SOS_SERVICE_MONGODB_URI: ${{ secrets.SOS_SERVICE_MONGODB_URI }}
        SOS_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.SOS_SERVICE_MONGODB_URI_OPTIONS }}
        USER_SECRET: ${{ secrets.USER_SECRET }}
        LIGHTSAIL_HOST_PILOT: ${{ secrets.LIGHTSAIL_HOST_PILOT }}
      run: |
        python3 << 'PYSCRIPT'
        import os
        env_type = "${{ github.event.inputs.environment }}"
        
        env_vars = {}
        
        if env_type == "PROD":
          env_vars = {
            "LIGHTSAIL_HOST": os.getenv("LIGHTSAIL_HOST_PROD", ""),
            "MONGODB_URI": os.getenv("MONGODB_URI_PROD", ""),
          }
        elif env_type == "PILOT":
          env_vars = {
            "CORS_ORIGIN": os.getenv("CORS_ORIGIN", ""),
            "INVITE_LINK_HOST": os.getenv("INVITE_LINK_HOST", ""),
            "JWT_PUBLIC_KEY": os.getenv("JWT_PUBLIC_KEY", ""),
            "LOG_LEVEL": os.getenv("LOG_LEVEL", ""),
            "MONGODB_POOL_SIZE": os.getenv("MONGODB_POOL_SIZE", ""),
            "REDIS_DB": os.getenv("REDIS_DB", ""),
            "REDIS_PORT": os.getenv("REDIS_PORT", ""),
            "SEMAPHORE_API_URL": os.getenv("SEMAPHORE_API_URL", ""),
            "TOKEN_REVOCATION_CACHE_TTL": os.getenv("TOKEN_REVOCATION_CACHE_TTL", ""),
            "TOKEN_REVOCATION_ENABLED": os.getenv("TOKEN_REVOCATION_ENABLED", ""),
            "CITY_SERVICE_DB_NAME": os.getenv("CITY_SERVICE_DB_NAME", ""),
            "CITY_SERVICE_MONGODB_URI": os.getenv("CITY_SERVICE_MONGODB_URI", ""),
            "CITY_SERVICE_MONGODB_URI_OPTIONS": os.getenv("CITY_SERVICE_MONGODB_URI_OPTIONS", ""),
            "CLIENT_ID_ADMIN": os.getenv("CLIENT_ID_ADMIN", ""),
            "CLIENT_ID_RESCUE": os.getenv("CLIENT_ID_RESCUE", ""),
            "ENCRYPTION_KEY": os.getenv("ENCRYPTION_KEY", ""),
            "FIREBASE_ADMIN_SDK_KEY": os.getenv("FIREBASE_ADMIN_SDK_KEY", ""),
            "GEO_SERVICE_DB_NAME": os.getenv("GEO_SERVICE_DB_NAME", ""),
            "GEO_SERVICE_MONGODB_URI_OPTIONS": os.getenv("GEO_SERVICE_MONGODB_URI_OPTIONS", ""),
            "IDENTITY_SERVICE_DB_NAME": os.getenv("IDENTITY_SERVICE_DB_NAME", ""),
            "IDENTITY_SERVICE_MONGODB_URI": os.getenv("IDENTITY_SERVICE_MONGODB_URI", ""),
            "IDENTITY_SERVICE_MONGODB_URI_OPTIONS": os.getenv("IDENTITY_SERVICE_MONGODB_URI_OPTIONS", ""),
            "INCIDENT_DB_NAME": os.getenv("INCIDENT_DB_NAME", ""),
            "INCIDENT_MONGODB_URI": os.getenv("INCIDENT_MONGODB_URI", ""),
            "INCIDENT_MONGODB_URI_OPTIONS": os.getenv("INCIDENT_MONGODB_URI_OPTIONS", ""),
            "INTERNAL_AUTH_TOKEN": os.getenv("INTERNAL_AUTH_TOKEN", ""),
            "JWT_ACCESS_SECRET": os.getenv("JWT_ACCESS_SECRET", ""),
            "JWT_REFRESH_SECRET": os.getenv("JWT_REFRESH_SECRET", ""),
            "OTP_SECRET": os.getenv("OTP_SECRET", ""),
            "REDIS_HOST": os.getenv("REDIS_HOST", ""),
            "REDIS_PASSWORD": os.getenv("REDIS_PASSWORD", ""),
            "SEMAPHORE_API_KEY": os.getenv("SEMAPHORE_API_KEY", ""),
            "SOS_SERVICE_MONGODB_URI": os.getenv("SOS_SERVICE_MONGODB_URI", ""),
            "SOS_SERVICE_MONGODB_URI_OPTIONS": os.getenv("SOS_SERVICE_MONGODB_URI_OPTIONS", ""),
            "USER_SECRET": os.getenv("USER_SECRET", ""),
            "LIGHTSAIL_HOST_PILOT": os.getenv("LIGHTSAIL_HOST_PILOT", ""),
          }
        else:
          env_vars = {
            "LIGHTSAIL_HOST": os.getenv("LIGHTSAIL_HOST_DEV", ""),
            "MONGODB_URI": os.getenv("MONGODB_URI_DEV", ""),
          }
        
        with open(".env", "w", newline="\n") as f:
          for key, value in env_vars.items():
            if value:
              f.write(f'{key}="{value}"\n')
        PYSCRIPT
        dos2unix .env || true

    - name: Test
      run: |
        echo "Test - Not implemented in code yet"

    - name: Lint
      run: |
        SERVICE="${{ github.event.inputs.service }}"
        
        if [ "$SERVICE" = "ALL" ]; then
          # Lint all services that have lint script
          for dir in services/* bff/*; do
            if [ -f "$dir/package.json" ] && grep -q '"lint"' "$dir/package.json"; then
              echo "Linting $dir"
              cd "$dir"
              npm install
              # Check if eslint config exists
              if [ -f ".eslintrc" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.yml" ] || [ -f ".eslintrc.yaml" ] || grep -q '"eslintConfig"' package.json; then
                npm run lint
              else
                echo "No eslint config found in $dir, skipping lint"
              fi
              cd ../../..
            fi
          done
        elif [ "$SERVICE" = "nginx" ] || [ "$SERVICE" = "kong" ]; then
          echo "No lint for $SERVICE"
        else
          if [ -f "services/$SERVICE/package.json" ]; then
            cd "services/$SERVICE"
            npm install
            if grep -q '"lint"' package.json; then
              # Check if eslint config exists
              if [ -f ".eslintrc" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.yml" ] || [ -f ".eslintrc.yaml" ] || grep -q '"eslintConfig"' package.json; then
                npm run lint
              else
                echo "No eslint config found, skipping lint for $SERVICE"
              fi
            else
              echo "No lint script for $SERVICE"
            fi
            cd ../../..
          elif [ -f "bff/$SERVICE/package.json" ]; then
            cd "bff/$SERVICE"
            npm install
            if grep -q '"lint"' package.json; then
              # Check if eslint config exists
              if [ -f ".eslintrc" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ] || [ -f ".eslintrc.yml" ] || [ -f ".eslintrc.yaml" ] || grep -q '"eslintConfig"' package.json; then
                npm run lint
              else
                echo "No eslint config found, skipping lint for $SERVICE"
              fi
            else
              echo "No lint script for $SERVICE"
            fi
            cd ../../..
          fi
        fi

    - name: Build Docker Images
      env:
        COMPOSE_FILE: ${{ env.COMPOSE_FILE }}
        PROJECT_NAME: ${{ env.PROJECT_NAME }}
        SERVICE: ${{ env.SERVICE }}
      run: |
        if [ -n "$SERVICE" ]; then
          docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" build $SERVICE
        else
          # Build all services
          docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" build
        fi

    - name: Deploy to Server
      env:
        COMPOSE_FILE: ${{ env.COMPOSE_FILE }}
        PROJECT_NAME: ${{ env.PROJECT_NAME }}
        SERVICE: ${{ env.SERVICE }}
      run: |
        echo "=========================================="
        echo "Deployment started at $(date)"
        echo "=========================================="
        echo "COMPOSE_FILE: $COMPOSE_FILE"
        echo "PROJECT_NAME: $PROJECT_NAME"
        echo "SERVICE: $SERVICE"
        echo ""
        
        # Check if compose file exists
        if [ ! -f "$COMPOSE_FILE" ]; then
          echo "ERROR: Compose file not found: $COMPOSE_FILE"
          ls -la
          exit 1
        fi
        
        # Validate compose file
        echo "Validating compose file..."
        docker-compose -f "$COMPOSE_FILE" config > /dev/null || {
          echo "ERROR: Invalid docker compose file"
          exit 1
        }
        
        # Stop existing containers
        echo "Stopping existing containers for project $PROJECT_NAME..."
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" down || true
        
        # Deploy containers
        echo "Starting containers..."
        if [ -n "$SERVICE" ]; then
          echo "Deploying service: $SERVICE"
          docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d $SERVICE
        else
          echo "Deploying all services..."
          docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" up -d
        fi
        
        # Verify deployment - wait a moment for containers to start
        sleep 3
        echo "Checking running containers..."
        docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" ps
        
        # Check if any containers exited with error
        echo ""
        echo "Checking container health..."
        STATUS=$(docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" ps --status=exited 2>/dev/null || echo "")
        if [ ! -z "$STATUS" ]; then
          echo "WARNING: Some containers have exited:"
          echo "$STATUS"
          echo ""
          echo "Checking logs for errors..."
          docker-compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" logs --tail=50
        fi
        
        echo ""
        echo "=========================================="
        echo "Deployment completed successfully!"
        echo "=========================================="