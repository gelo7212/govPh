name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment to deploy'
        required: true
        default: 'PILOT'
        type: choice
        options:
          - DEV
          - PILOT
          - PROD
      service:
        description: 'Choose service to deploy'
        required: true
        default: 'ALL'
        type: choice
        options:
          - ALL
          - nginx
          - kong
          - bff-citizen
          - bff-admin
          - sos-service
          - identity-service
          - geo-service
          - realtime-service
          - incident-service
          - city-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up environment variables
      id: set-env
      run: |
        ENV="${{ github.event.inputs.environment }}"
        SERVICE="${{ github.event.inputs.service }}"

        if [ "$SERVICE" = "ALL" ]; then
          SERVICE=""
        fi

        echo "ENV_FILE=.env.${ENV,,}" >> $GITHUB_ENV
        echo "COMPOSE_FILE=docker-compose.${ENV,,}.yml" >> $GITHUB_ENV
        echo "PROJECT_NAME=ecitizen-${ENV,,}" >> $GITHUB_ENV
        echo "SERVICE=$SERVICE" >> $GITHUB_ENV

        # Set environment-specific variables
        if [ "$ENV" = "PROD" ]; then
          echo "LIGHTSAIL_HOST=${{ secrets.LIGHTSAIL_HOST_PROD }}" >> $GITHUB_ENV
          echo "MONGODB_URI=${{ secrets.MONGODB_URI_PROD }}" >> $GITHUB_ENV
        elif [ "$ENV" = "PILOT" ]; then
          echo "LIGHTSAIL_HOST=${{ secrets.LIGHTSAIL_HOST_PILOT }}" >> $GITHUB_ENV
          # Non-secret environment variables
          echo "CORS_ORIGIN=${{ vars.CORS_ORIGIN }}" >> $GITHUB_ENV
          echo "INVITE_LINK_HOST=${{ vars.INVITE_LINK_HOST }}" >> $GITHUB_ENV
          echo "JWT_PUBLIC_KEY=${{ vars.JWT_PUBLIC_KEY }}" >> $GITHUB_ENV
          echo "LOG_LEVEL=${{ vars.LOG_LEVEL }}" >> $GITHUB_ENV
          echo "MONGODB_POOL_SIZE=${{ vars.MONGODB_POOL_SIZE }}" >> $GITHUB_ENV
          echo "REDIS_DB=${{ vars.REDIS_DB }}" >> $GITHUB_ENV
          echo "REDIS_PORT=${{ vars.REDIS_PORT }}" >> $GITHUB_ENV
          echo "SEMAPHORE_API_URL=${{ vars.SEMAPHORE_API_URL }}" >> $GITHUB_ENV
          echo "TOKEN_REVOCATION_CACHE_TTL=${{ vars.TOKEN_REVOCATION_CACHE_TTL }}" >> $GITHUB_ENV
          echo "TOKEN_REVOCATION_ENABLED=${{ vars.TOKEN_REVOCATION_ENABLED }}" >> $GITHUB_ENV
          # Secret environment variables
          echo "CITY_SERVICE_DB_NAME=${{ secrets.CITY_SERVICE_DB_NAME }}" >> $GITHUB_ENV
          echo "CITY_SERVICE_MONGODB_URI=${{ secrets.CITY_SERVICE_MONGODB_URI }}" >> $GITHUB_ENV
          echo "CITY_SERVICE_MONGODB_URI_OPTIONS=${{ secrets.CITY_SERVICE_MONGODB_URI_OPTIONS }}" >> $GITHUB_ENV
          echo "CLIENT_ID_ADMIN=${{ secrets.CLIENT_ID_ADMIN }}" >> $GITHUB_ENV
          echo "CLIENT_ID_RESCUE=${{ secrets.CLIENT_ID_RESCUE }}" >> $GITHUB_ENV
          echo "ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}" >> $GITHUB_ENV
          echo "FIREBASE_ADMIN_SDK_KEY=${{ secrets.FIREBASE_ADMIN_SDK_KEY }}" >> $GITHUB_ENV
          echo "GEO_SERVICE_DB_NAME=${{ secrets.GEO_SERVICE_DB_NAME }}" >> $GITHUB_ENV
          echo "GEO_SERVICE_MONGODB_URI_OPTIONS=${{ secrets.GEO_SERVICE_MONGODB_URI_OPTIONS }}" >> $GITHUB_ENV
          echo "IDENTITY_SERVICE_DB_NAME=${{ secrets.IDENTITY_SERVICE_DB_NAME }}" >> $GITHUB_ENV
          echo "IDENTITY_SERVICE_MONGODB_URI=${{ secrets.IDENTITY_SERVICE_MONGODB_URI }}" >> $GITHUB_ENV
          echo "IDENTITY_SERVICE_MONGODB_URI_OPTIONS=${{ secrets.IDENTITY_SERVICE_MONGODB_URI_OPTIONS }}" >> $GITHUB_ENV
          echo "INCIDENT_DB_NAME=${{ secrets.INCIDENT_DB_NAME }}" >> $GITHUB_ENV
          echo "INCIDENT_MONGODB_URI=${{ secrets.INCIDENT_MONGODB_URI }}" >> $GITHUB_ENV
          echo "INCIDENT_MONGODB_URI_OPTIONS=${{ secrets.INCIDENT_MONGODB_URI_OPTIONS }}" >> $GITHUB_ENV
          echo "INTERNAL_AUTH_TOKEN=${{ secrets.INTERNAL_AUTH_TOKEN }}" >> $GITHUB_ENV
          echo "JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}" >> $GITHUB_ENV
          echo "JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}" >> $GITHUB_ENV
          echo "OTP_SECRET=${{ secrets.OTP_SECRET }}" >> $GITHUB_ENV
          echo "REDIS_HOST=${{ secrets.REDIS_HOST }}" >> $GITHUB_ENV
          echo "REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}" >> $GITHUB_ENV
          echo "SEMAPHORE_API_KEY=${{ secrets.SEMAPHORE_API_KEY }}" >> $GITHUB_ENV
          echo "SOS_SERVICE_MONGODB_URI=${{ secrets.SOS_SERVICE_MONGODB_URI }}" >> $GITHUB_ENV
          echo "SOS_SERVICE_MONGODB_URI_OPTIONS=${{ secrets.SOS_SERVICE_MONGODB_URI_OPTIONS }}" >> $GITHUB_ENV
          echo "USER_SECRET=${{ secrets.USER_SECRET }}" >> $GITHUB_ENV
        else
          echo "LIGHTSAIL_HOST=${{ secrets.LIGHTSAIL_HOST_DEV }}" >> $GITHUB_ENV
          echo "MONGODB_URI=${{ secrets.MONGODB_URI_DEV }}" >> $GITHUB_ENV
        fi

    - name: Add Lightsail SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.LIGHTSAIL_KEY }}" > ~/.ssh/lightsail-key.pem
        chmod 400 ~/.ssh/lightsail-key.pem

    - name: Write .env safely
      run: |
        cat << 'EOF' > .env
        ${{ env.ENV_FILE }}
        EOF

    - name: Build and Save Docker Images
      run: |
        if [ -n "$SERVICE" ]; then
          docker-compose -f ${{ env.COMPOSE_FILE }} -p ${{ env.PROJECT_NAME }} build $SERVICE
          docker save ${{ env.PROJECT_NAME }}_${SERVICE}:latest -o ${SERVICE}.tar
        else
          # Build all services
          docker-compose -f ${{ env.COMPOSE_FILE }} -p ${{ env.PROJECT_NAME }} build

          # Save images
          docker save ${{ env.PROJECT_NAME }}_nginx:latest -o nginx.tar
          docker save ${{ env.PROJECT_NAME }}_kong:latest -o kong.tar
          docker save ${{ env.PROJECT_NAME }}_bff-citizen:latest -o bff-citizen.tar
          docker save ${{ env.PROJECT_NAME }}_bff-admin:latest -o bff-admin.tar
          docker save ${{ env.PROJECT_NAME }}_sos-service:latest -o sos-service.tar
          docker save ${{ env.PROJECT_NAME }}_identity-service:latest -o identity-service.tar
          docker save ${{ env.PROJECT_NAME }}_geo-service:latest -o geo-service.tar
          docker save ${{ env.PROJECT_NAME }}_realtime-service:latest -o realtime-service.tar
          docker save ${{ env.PROJECT_NAME }}_incident-service:latest -o incident-service.tar
          docker save ${{ env.PROJECT_NAME }}_city-service:latest -o city-service.tar
        fi

    - name: Deploy to Lightsail
      run: |
        if [ -n "$SERVICE" ]; then
          scp -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no \
            ${SERVICE}.tar ${{ env.COMPOSE_FILE }} .env ubuntu@${{ env.LIGHTSAIL_HOST }}:/home/ubuntu/
        else
          scp -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no \
            *.tar ${{ env.COMPOSE_FILE }} .env ubuntu@${{ env.LIGHTSAIL_HOST }}:/home/ubuntu/
        fi

        # Deploy
        ssh -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no ubuntu@${{ env.LIGHTSAIL_HOST }} "
          # Stop existing containers
          sudo docker-compose -f ${{ env.COMPOSE_FILE }} -p ${{ env.PROJECT_NAME }} down || true

          if [ -n \"$SERVICE\" ]; then
            sudo docker load < ${SERVICE}.tar
            sudo docker-compose -f ${{ env.COMPOSE_FILE }} -p ${{ env.PROJECT_NAME }} up -d $SERVICE
          else
            sudo docker load < nginx.tar
            sudo docker load < kong.tar
            sudo docker load < bff-citizen.tar
            sudo docker load < bff-admin.tar
            sudo docker load < sos-service.tar
            sudo docker load < identity-service.tar
            sudo docker load < geo-service.tar
            sudo docker load < realtime-service.tar
            sudo docker load < incident-service.tar
            sudo docker load < city-service.tar
            sudo docker-compose -f ${{ env.COMPOSE_FILE }} -p ${{ env.PROJECT_NAME }} up -d
          fi

          # Cleanup
          rm *.tar ${{ env.COMPOSE_FILE }} .env
        "

    - name: Cleanup
      run: rm *.tar