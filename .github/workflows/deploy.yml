name: CI/CD Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Choose environment to deploy'
        required: true
        default: 'PILOT'
        type: choice
        options:
          - DEV
          - PILOT
          - PROD
      service:
        description: 'Choose service to deploy'
        required: true
        default: 'ALL'
        type: choice
        options:
          - ALL
          - nginx
          - kong
          - bff-citizen
          - bff-admin
          - sos-service
          - identity-service
          - geo-service
          - realtime-service
          - incident-service
          - city-service

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up environment variables
      id: set-env
      run: |
        ENV="${{ github.event.inputs.environment }}"
        SERVICE="${{ github.event.inputs.service }}"

        if [ "$SERVICE" = "ALL" ]; then
          SERVICE=""
        fi

        echo "COMPOSE_FILE=docker-compose.${ENV,,}.yml" >> $GITHUB_ENV
        echo "PROJECT_NAME=ecitizen-${ENV,,}" >> $GITHUB_ENV
        echo "SERVICE=$SERVICE" >> $GITHUB_ENV

    - name: Create .env file
      env:
        LIGHTSAIL_HOST_PROD: ${{ secrets.LIGHTSAIL_HOST_PROD }}
        MONGODB_URI_PROD: ${{ secrets.MONGODB_URI_PROD }}
        LIGHTSAIL_HOST_DEV: ${{ secrets.LIGHTSAIL_HOST_DEV }}
        MONGODB_URI_DEV: ${{ secrets.MONGODB_URI_DEV }}
        CORS_ORIGIN: ${{ vars.CORS_ORIGIN }}
        INVITE_LINK_HOST: ${{ vars.INVITE_LINK_HOST }}
        JWT_PUBLIC_KEY: ${{ vars.JWT_PUBLIC_KEY }}
        LOG_LEVEL: ${{ vars.LOG_LEVEL }}
        MONGODB_POOL_SIZE: ${{ vars.MONGODB_POOL_SIZE }}
        REDIS_DB: ${{ vars.REDIS_DB }}
        REDIS_PORT: ${{ vars.REDIS_PORT }}
        SEMAPHORE_API_URL: ${{ vars.SEMAPHORE_API_URL }}
        TOKEN_REVOCATION_CACHE_TTL: ${{ vars.TOKEN_REVOCATION_CACHE_TTL }}
        TOKEN_REVOCATION_ENABLED: ${{ vars.TOKEN_REVOCATION_ENABLED }}
        CITY_SERVICE_DB_NAME: ${{ secrets.CITY_SERVICE_DB_NAME }}
        CITY_SERVICE_MONGODB_URI: ${{ secrets.CITY_SERVICE_MONGODB_URI }}
        CITY_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.CITY_SERVICE_MONGODB_URI_OPTIONS }}
        CLIENT_ID_ADMIN: ${{ secrets.CLIENT_ID_ADMIN }}
        CLIENT_ID_RESCUE: ${{ secrets.CLIENT_ID_RESCUE }}
        ENCRYPTION_KEY: ${{ secrets.ENCRYPTION_KEY }}
        FIREBASE_ADMIN_SDK_KEY: ${{ secrets.FIREBASE_ADMIN_SDK_KEY }}
        GEO_SERVICE_DB_NAME: ${{ secrets.GEO_SERVICE_DB_NAME }}
        GEO_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.GEO_SERVICE_MONGODB_URI_OPTIONS }}
        IDENTITY_SERVICE_DB_NAME: ${{ secrets.IDENTITY_SERVICE_DB_NAME }}
        IDENTITY_SERVICE_MONGODB_URI: ${{ secrets.IDENTITY_SERVICE_MONGODB_URI }}
        IDENTITY_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.IDENTITY_SERVICE_MONGODB_URI_OPTIONS }}
        INCIDENT_DB_NAME: ${{ secrets.INCIDENT_DB_NAME }}
        INCIDENT_MONGODB_URI: ${{ secrets.INCIDENT_MONGODB_URI }}
        INCIDENT_MONGODB_URI_OPTIONS: ${{ secrets.INCIDENT_MONGODB_URI_OPTIONS }}
        INTERNAL_AUTH_TOKEN: ${{ secrets.INTERNAL_AUTH_TOKEN }}
        JWT_ACCESS_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
        JWT_REFRESH_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
        OTP_SECRET: ${{ secrets.OTP_SECRET }}
        REDIS_HOST: ${{ secrets.REDIS_HOST }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        SEMAPHORE_API_KEY: ${{ secrets.SEMAPHORE_API_KEY }}
        SOS_SERVICE_MONGODB_URI: ${{ secrets.SOS_SERVICE_MONGODB_URI }}
        SOS_SERVICE_MONGODB_URI_OPTIONS: ${{ secrets.SOS_SERVICE_MONGODB_URI_OPTIONS }}
        USER_SECRET: ${{ secrets.USER_SECRET }}
        LIGHTSAIL_HOST_PILOT: ${{ secrets.LIGHTSAIL_HOST_PILOT }}
      run: |
        python3 << 'PYSCRIPT'
        import os
        env_type = "${{ github.event.inputs.environment }}"
        
        env_vars = {}
        
        if env_type == "PROD":
          env_vars = {
            "LIGHTSAIL_HOST": os.getenv("LIGHTSAIL_HOST_PROD", ""),
            "MONGODB_URI": os.getenv("MONGODB_URI_PROD", ""),
          }
        elif env_type == "PILOT":
          env_vars = {
            "CORS_ORIGIN": os.getenv("CORS_ORIGIN", ""),
            "INVITE_LINK_HOST": os.getenv("INVITE_LINK_HOST", ""),
            "JWT_PUBLIC_KEY": os.getenv("JWT_PUBLIC_KEY", ""),
            "LOG_LEVEL": os.getenv("LOG_LEVEL", ""),
            "MONGODB_POOL_SIZE": os.getenv("MONGODB_POOL_SIZE", ""),
            "REDIS_DB": os.getenv("REDIS_DB", ""),
            "REDIS_PORT": os.getenv("REDIS_PORT", ""),
            "SEMAPHORE_API_URL": os.getenv("SEMAPHORE_API_URL", ""),
            "TOKEN_REVOCATION_CACHE_TTL": os.getenv("TOKEN_REVOCATION_CACHE_TTL", ""),
            "TOKEN_REVOCATION_ENABLED": os.getenv("TOKEN_REVOCATION_ENABLED", ""),
            "CITY_SERVICE_DB_NAME": os.getenv("CITY_SERVICE_DB_NAME", ""),
            "CITY_SERVICE_MONGODB_URI": os.getenv("CITY_SERVICE_MONGODB_URI", ""),
            "CITY_SERVICE_MONGODB_URI_OPTIONS": os.getenv("CITY_SERVICE_MONGODB_URI_OPTIONS", ""),
            "CLIENT_ID_ADMIN": os.getenv("CLIENT_ID_ADMIN", ""),
            "CLIENT_ID_RESCUE": os.getenv("CLIENT_ID_RESCUE", ""),
            "ENCRYPTION_KEY": os.getenv("ENCRYPTION_KEY", ""),
            "FIREBASE_ADMIN_SDK_KEY": os.getenv("FIREBASE_ADMIN_SDK_KEY", ""),
            "GEO_SERVICE_DB_NAME": os.getenv("GEO_SERVICE_DB_NAME", ""),
            "GEO_SERVICE_MONGODB_URI_OPTIONS": os.getenv("GEO_SERVICE_MONGODB_URI_OPTIONS", ""),
            "IDENTITY_SERVICE_DB_NAME": os.getenv("IDENTITY_SERVICE_DB_NAME", ""),
            "IDENTITY_SERVICE_MONGODB_URI": os.getenv("IDENTITY_SERVICE_MONGODB_URI", ""),
            "IDENTITY_SERVICE_MONGODB_URI_OPTIONS": os.getenv("IDENTITY_SERVICE_MONGODB_URI_OPTIONS", ""),
            "INCIDENT_DB_NAME": os.getenv("INCIDENT_DB_NAME", ""),
            "INCIDENT_MONGODB_URI": os.getenv("INCIDENT_MONGODB_URI", ""),
            "INCIDENT_MONGODB_URI_OPTIONS": os.getenv("INCIDENT_MONGODB_URI_OPTIONS", ""),
            "INTERNAL_AUTH_TOKEN": os.getenv("INTERNAL_AUTH_TOKEN", ""),
            "JWT_ACCESS_SECRET": os.getenv("JWT_ACCESS_SECRET", ""),
            "JWT_REFRESH_SECRET": os.getenv("JWT_REFRESH_SECRET", ""),
            "OTP_SECRET": os.getenv("OTP_SECRET", ""),
            "REDIS_HOST": os.getenv("REDIS_HOST", ""),
            "REDIS_PASSWORD": os.getenv("REDIS_PASSWORD", ""),
            "SEMAPHORE_API_KEY": os.getenv("SEMAPHORE_API_KEY", ""),
            "SOS_SERVICE_MONGODB_URI": os.getenv("SOS_SERVICE_MONGODB_URI", ""),
            "SOS_SERVICE_MONGODB_URI_OPTIONS": os.getenv("SOS_SERVICE_MONGODB_URI_OPTIONS", ""),
            "USER_SECRET": os.getenv("USER_SECRET", ""),
            "LIGHTSAIL_HOST_PILOT": os.getenv("LIGHTSAIL_HOST_PILOT", ""),
          }
        else:
          env_vars = {
            "LIGHTSAIL_HOST": os.getenv("LIGHTSAIL_HOST_DEV", ""),
            "MONGODB_URI": os.getenv("MONGODB_URI_DEV", ""),
          }
        
        with open(".env", "w", newline="\n") as f:
          for key, value in env_vars.items():
            if value:
              f.write(f'{key}="{value}"\n')
        PYSCRIPT
        dos2unix .env || true

    - name: Build and Save Docker Images
      if: ${{ github.event.inputs.environment != 'PILOT' }}
      env:
        COMPOSE_FILE: ${{ env.COMPOSE_FILE }}
        PROJECT_NAME: ${{ env.PROJECT_NAME }}
        SERVICE: ${{ env.SERVICE }}
      run: |
        if [ -n "$SERVICE" ]; then
          docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" build $SERVICE
          docker save ${PROJECT_NAME}_${SERVICE}:latest -o ${SERVICE}.tar
        else
          # Build all services
          docker compose -f "$COMPOSE_FILE" -p "$PROJECT_NAME" build

          # Save images
          docker save ${PROJECT_NAME}_nginx:latest -o nginx.tar
          docker save ${PROJECT_NAME}_kong:latest -o kong.tar
          docker save ${PROJECT_NAME}_bff-citizen:latest -o bff-citizen.tar
          docker save ${PROJECT_NAME}_bff-admin:latest -o bff-admin.tar
          docker save ${PROJECT_NAME}_sos-service:latest -o sos-service.tar
          docker save ${PROJECT_NAME}_identity-service:latest -o identity-service.tar
          docker save ${PROJECT_NAME}_geo-service:latest -o geo-service.tar
          docker save ${PROJECT_NAME}_realtime-service:latest -o realtime-service.tar
          docker save ${PROJECT_NAME}_incident-service:latest -o incident-service.tar
          docker save ${PROJECT_NAME}_city-service:latest -o city-service.tar
        fi

    - name: Deploy to Lightsail
      env:
        COMPOSE_FILE: ${{ env.COMPOSE_FILE }}
        PROJECT_NAME: ${{ env.PROJECT_NAME }}
        SERVICE: ${{ env.SERVICE }}
        LIGHTSAIL_KEY: ${{ secrets.LIGHTSAIL_KEY }}
        LIGHTSAIL_HOST_PROD: ${{ secrets.LIGHTSAIL_HOST_PROD }}
        LIGHTSAIL_HOST_DEV: ${{ secrets.LIGHTSAIL_HOST_DEV }}
        LIGHTSAIL_HOST_PILOT: ${{ secrets.LIGHTSAIL_HOST_PILOT }}
      run: |
        ENV="${{ github.event.inputs.environment }}"
        
        case $ENV in
          PROD)
            LIGHTSAIL_HOST=$LIGHTSAIL_HOST_PROD
            DEPLOY_MODE="tar"
            ;;
          PILOT)
            LIGHTSAIL_HOST=$LIGHTSAIL_HOST_PILOT
            DEPLOY_MODE="compose"
            ;;
          *)
            LIGHTSAIL_HOST=$LIGHTSAIL_HOST_DEV
            DEPLOY_MODE="tar"
            ;;
        esac
        
          mkdir -p ~/.ssh
          cat << 'EOF' > ~/.ssh/lightsail-ci.pem
          ${{ secrets.LIGHTSAIL_KEY }}
          EOF
          chmod 400 ~/.ssh/lightsail-ci.pem

        
        if [ "$DEPLOY_MODE" = "compose" ]; then
          # PILOT: Copy compose file and .env, build and run on Lightsail
          scp -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no \
            "$COMPOSE_FILE" .env ubuntu@$LIGHTSAIL_HOST:/home/ubuntu/
          
          ssh -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no ubuntu@$LIGHTSAIL_HOST "
            cd /home/ubuntu
            # Stop existing containers
            sudo docker compose -f $COMPOSE_FILE -p $PROJECT_NAME down || true
            
            if [ -n \"$SERVICE\" ]; then
              sudo docker compose -f $COMPOSE_FILE -p $PROJECT_NAME up --build -d $SERVICE
            else
              sudo docker compose -f $COMPOSE_FILE -p $PROJECT_NAME up --build -d
            fi
            
            # Cleanup
            rm $COMPOSE_FILE .env
          "
        else
          # PROD/DEV: Use tar files (existing approach)
          if [ -n "$SERVICE" ]; then
            scp -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no \
              ${SERVICE}.tar "$COMPOSE_FILE" .env ubuntu@$LIGHTSAIL_HOST:/home/ubuntu/
          else
            scp -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no \
              *.tar "$COMPOSE_FILE" .env ubuntu@$LIGHTSAIL_HOST:/home/ubuntu/
          fi

          # Deploy
          ssh -i ~/.ssh/lightsail-key.pem -o StrictHostKeyChecking=no ubuntu@$LIGHTSAIL_HOST "
            cd /home/ubuntu
            # Stop existing containers
            sudo docker compose -f $COMPOSE_FILE -p $PROJECT_NAME down || true

            if [ -n \"$SERVICE\" ]; then
              sudo docker load < ${SERVICE}.tar
              sudo docker compose -f $COMPOSE_FILE -p $PROJECT_NAME up -d $SERVICE
            else
              sudo docker load < nginx.tar
              sudo docker load < kong.tar
              sudo docker load < bff-citizen.tar
              sudo docker load < bff-admin.tar
              sudo docker load < sos-service.tar
              sudo docker load < identity-service.tar
              sudo docker load < geo-service.tar
              sudo docker load < realtime-service.tar
              sudo docker load < incident-service.tar
              sudo docker load < city-service.tar
              sudo docker compose -f $COMPOSE_FILE -p $PROJECT_NAME up -d
            fi

            # Cleanup
            rm *.tar $COMPOSE_FILE .env
          "
        fi

    - name: Cleanup
      if: ${{ github.event.inputs.environment != 'PILOT' }}
      run: rm *.tar