services:
  # =====================
  # NGINX Reverse Proxy
  # =====================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: govph-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - kong
      - realtime-service
    networks:
      - govph-network
    environment:
      NODE_ENV: local
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  kong:
    image: kong:3.6
    container_name: govph-kong
    volumes:
      - ./gateway/kong.local.yml:/kong/declarative/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
    networks:
      - govph-network
    # Remove port mapping - access through nginx
    # ports:
    #   - "8000:8000"

  # =====================
  # BFF – Citizen (Mobile)
  # =====================
  bff-citizen:
    build:
      context: .
      dockerfile: bff/bff-citizen/Dockerfile
    container_name: govph-bff-citizen
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3000:3000"
    environment:
      NODE_ENV: local
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: /repo/bff/bff-citizen/src/firebase-service-account.json
      JWT_PUBLIC_KEY: "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxRek0X1VCnmuXyXIsGz4\nVy+Eotl050LatEcWdD535zSaTlsbP3qiPPvG5xj2AX9vOitzq+L5k45dk99/MYns\n49H2oHFbNq6S4Srq6QFo19/mV/IMdwgV5svSq+dPPpiE9p0R/kjzDMtpJed1Z8IK\n/pr2PD7ap7ybnnxumpIV/R8jTtqi25WCMl05MGQfLtl/wsHeXuL10xloDB7WlUcz\nK3OjQc7pJ4D4cprkXeYT9YdCJ/cEhiaMmhjeEhed/Z9twqlBKqohvZjUpjL1zequ\nygTsriA0niEplyfUGOoirxQbnwpgCE0gGp6OQEwtyev1clmwkPEXr71s0PgBAron\n0QIDAQAB\n-----END PUBLIC KEY-----"
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      # Service URLs (use Docker internal network)
      IDENTITY_SERVICE_URL: "http://govph-identity:3000"
      GEO_SERVICE_URL: "http://govph-geo:3000"
      SOS_SERVICE_URL: "http://govph-sos:3000"
      REALTIME_SERVICE_URL: "http://govph-realtime:3000"
      INCIDENT_MS_URL: "http://govph-incident:3000"
  # =====================
  # BFF – Admin (Web)
  # =====================
  bff-admin:
    build:
      context: .
      dockerfile: bff/bff-admin/Dockerfile
    container_name: govph-bff-admin
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3004:3000"
    environment:
      NODE_ENV: local
      PORT: 3000

  sos-service:
    build: ./services/sos-service
    container_name: govph-sos
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3001:3000"
    environment:
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      PORT: 3000

  identity-service:
    build: ./services/identity-service
    container_name: govph-identity
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3002:3000"
    environment:
      PORT: 3000

  geo-service:
    build: ./services/geo-service
    container_name: govph-geo
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3003:3000"
    environment:
      PORT: 3000

  realtime-service:
    build: ./services/realtime-service
    container_name: govph-realtime
    networks:
      - govph-network
    # Remove port mapping - access through nginx
    # ports:
    #   - "3005:3000"
    environment:
      PORT: 3000

  incident-service:
    build: ./services/incident-service
    container_name: govph-incident
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3006:3000"
    environment:
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      PORT: 3000

networks:
  govph-network:
    driver: bridge