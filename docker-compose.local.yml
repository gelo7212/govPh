services:
  # =====================
  # NGINX Reverse Proxy
  # =====================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: govph-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - kong
      - realtime-service
    networks:
      - govph-network
    environment:
      NODE_ENV: local
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  kong:
    image: kong:3.6
    container_name: govph-kong
    volumes:
      - ./gateway/kong.local.yml:/kong/declarative/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
    networks:
      - govph-network
    # Remove port mapping - access through nginx
    # ports:
    #   - "8000:8000"

  # =====================
  # BFF – Citizen (Mobile)
  # =====================
  bff-citizen:
    build:
      context: .
      dockerfile: bff/bff-citizen/Dockerfile
    container_name: govph-bff-citizen
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3000:3000"
    environment:
      NODE_ENV: local
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: /repo/bff/bff-citizen/src/firebase-service-account.json
      JWT_PUBLIC_KEY: "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxRek0X1VCnmuXyXIsGz4\nVy+Eotl050LatEcWdD535zSaTlsbP3qiPPvG5xj2AX9vOitzq+L5k45dk99/MYns\n49H2oHFbNq6S4Srq6QFo19/mV/IMdwgV5svSq+dPPpiE9p0R/kjzDMtpJed1Z8IK\n/pr2PD7ap7ybnnxumpIV/R8jTtqi25WCMl05MGQfLtl/wsHeXuL10xloDB7WlUcz\nK3OjQc7pJ4D4cprkXeYT9YdCJ/cEhiaMmhjeEhed/Z9twqlBKqohvZjUpjL1zequ\nygTsriA0niEplyfUGOoirxQbnwpgCE0gGp6OQEwtyev1clmwkPEXr71s0PgBAron\n0QIDAQAB\n-----END PUBLIC KEY-----"
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      # Service URLs (use Docker internal network)
      IDENTITY_SERVICE_URL: "http://govph-identity:3000"
      GEO_SERVICE_URL: "http://govph-geo:3000"
      SOS_SERVICE_URL: "http://govph-sos:3000"
      REALTIME_SERVICE_URL: "http://govph-realtime:3000"
      INCIDENT_MS_URL: "http://govph-incident:3000"
      CLIENT_ID_ADMIN: 'gov-ph-admin-client'
      CLIENT_ID_RESCUE: 'gov-ph-rescue-client'

      
  # =====================
  # BFF – Admin (Web)
  # =====================
  bff-admin:
    build:
      context: .
      dockerfile: bff/bff-admin/Dockerfile
    container_name: govph-bff-admin
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3004:3000"
    environment:
      NODE_ENV: local
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: /repo/bff/bff-admin/src/firebase-service-account.json
      JWT_PUBLIC_KEY: "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxRek0X1VCnmuXyXIsGz4\nVy+Eotl050LatEcWdD535zSaTlsbP3qiPPvG5xj2AX9vOitzq+L5k45dk99/MYns\n49H2oHFbNq6S4Srq6QFo19/mV/IMdwgV5svSq+dPPpiE9p0R/kjzDMtpJed1Z8IK\n/pr2PD7ap7ybnnxumpIV/R8jTtqi25WCMl05MGQfLtl/wsHeXuL10xloDB7WlUcz\nK3OjQc7pJ4D4cprkXeYT9YdCJ/cEhiaMmhjeEhed/Z9twqlBKqohvZjUpjL1zequ\nygTsriA0niEplyfUGOoirxQbnwpgCE0gGp6OQEwtyev1clmwkPEXr71s0PgBAron\n0QIDAQAB\n-----END PUBLIC KEY-----"
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      # Service URLs (use Docker internal network)
      IDENTITY_SERVICE_URL: "http://govph-identity:3000"
      GEO_SERVICE_URL: "http://govph-geo:3000"
      SOS_SERVICE_URL: "http://govph-sos:3000"
      REALTIME_SERVICE_URL: "http://govph-realtime:3000"
      INCIDENT_MS_URL: "http://govph-incident:3000"
      CITY_SERVICE_URL: "http://govph-city:3000"  
      SUBMISSION_SERVICE_URL: "http://govph-submission:3000"
      CLIENT_ID_ADMIN: 'gov-ph-admin-client'
      CLIENT_ID_RESCUE: 'gov-ph-rescue-client'


  sos-service: 
    build: ./services/sos-service
    container_name: govph-sos
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3001:3000"
    environment:
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      PORT: 3000
      REALTIME_SERVICE_URL: "http://govph-realtime:3000"
      IDENTITY_SERVICE_URL: "http://govph-identity:3000"
      NODE_ENV: local
      MICROSERVICE_NAME: sos-service
      CORS_ORIGIN: ${CORS_ORIGIN}
      MONGODB_URI: ${SOS_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${SOS_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${SOS_SERVICE_DB_NAME}
  
  identity-service:
    build: ./services/identity-service
    container_name: govph-identity
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3002:3000"
    environment:
      PORT: 3000
      SEMAPHORE_API_KEY: 1cd60ad27489bcbb49004d39f62f0d2e
      USER_SECRET: 526bb7e8b6efb4dacd6548111ae563f0131ce8de476d10b38a8a8ea189b34657
      ENCRYPTION_KEY: n++mnwYjzA/umoe981HWgdI4idmTRgPZ+fpd0Hu5ua0=
      OTP_SECRET: 526bb7e8b6efb4dacd6548111ae563f0131ce8de476d10b38a8a8ea189b34657
      INVITE_LINK_HOST: http://localhost:3000/invites

  geo-service:
    build: ./services/geo-service
    container_name: govph-geo
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3003:3000"
    environment:
      PORT: 3000
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      MICROSERVICE_NAME: geo-service
      CORS_ORIGIN: ${CORS_ORIGIN}
      MONGODB_URI: ${GEO_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${GEO_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${GEO_SERVICE_DB_NAME}

  realtime-service:
    build: ./services/realtime-service
    container_name: govph-realtime
    networks:
      - govph-network
    # Remove port mapping - access through nginx
    # ports:
    #   - "3005:3000"
    environment:
      PORT: 3000
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}

  incident-service:
    build: ./services/incident-service
    container_name: govph-incident
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3006:3004"
    environment:
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      PORT: 3000
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      MICROSERVICE_NAME: geo-service-pilot
      CORS_ORIGIN: ${CORS_ORIGIN}
      MONGODB_URI: ${INCIDENT_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${INCIDENT_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${INCIDENT_SERVICE_DB_NAME}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  city-service: 
    build: ./services/city-service
    container_name: govph-city
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3007:3000"
    environment:
      INTERNAL_AUTH_TOKEN: "N71p4faxRennjHmag79N8L16xWYGsytxKnOGjGwTC8A="
      PORT: 3000
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      MICROSERVICE_NAME: geo-service
      CORS_ORIGIN: ${CORS_ORIGIN}
      MONGODB_URI: ${CITY_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${CITY_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${CITY_SERVICE_DB_NAME}
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =====================
  # Submission Service
  # =====================
  submission-service:
    build: ./services/submission-service
    container_name: govph-submission
    networks:
      - govph-network
    # Internal only - accessed via Kong gateway
    # ports:
    #   - "3006:3006"
    environment:
      PORT: 3000
      NODE_ENV: local
      MONGODB_URI: ${SUBMISSION_SERVICE_MONGODB_URI:-mongodb://host.docker.internal:27017}
      MONGODB_URI_OPTIONS: ${SUBMISSION_SERVICE_MONGODB_URI_OPTIONS}
      IDENTITY_SERVICE_URL: "http://govph-identity:3000"
      CITY_SERVICE_URL: "http://govph-city:3000"
      LOG_LEVEL: debug
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # =====================
  # File Management Service
  # =====================
  file-management-service:
    build:
      context: ./services/file-management-service
    container_name: govph-file-management-service
    environment:
      NODE_ENV: ${NODE_ENV:-local}
      PORT: 3000
      MONGODB_URI: ${FILE_MANAGEMENT_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${FILE_MANAGEMENT_MONGODB_URI_OPTIONS}
      STORAGE_PROVIDER: LOCAL
      LOCAL_STORAGE_PATH: /app/uploads
      JWT_PUBLIC_KEY: "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxRek0X1VCnmuXyXIsGz4\nVy+Eotl050LatEcWdD535zSaTlsbP3qiPPvG5xj2AX9vOitzq+L5k45dk99/MYns\n49H2oHFbNq6S4Srq6QFo19/mV/IMdwgV5svSq+dPPpiE9p0R/kjzDMtpJed1Z8IK\n/pr2PD7ap7ybnnxumpIV/R8jTtqi25WCMl05MGQfLtl/wsHeXuL10xloDB7WlUcz\nK3OjQc7pJ4D4cprkXeYT9YdCJ/cEhiaMmhjeEhed/Z9twqlBKqohvZjUpjL1zequ\nygTsriA0niEplyfUGOoirxQbnwpgCE0gGp6OQEwtyev1clmwkPEXr71s0PgBAron\n0QIDAQAB\n-----END PUBLIC KEY-----"
      JWT_EXPIRY: 7d
      MAX_FILE_SIZE: 52428800
    volumes:
      - file_uploads:/app/uploads
    networks:
      - govph-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  govph-network:
    driver: bridge

volumes:
  file_uploads:
    driver: local