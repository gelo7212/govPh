version: "3.9"

services:
  # =====================
  # NGINX Reverse Proxy
  # =====================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: govph-nginx-pilot
    ports:
      - "8080:80"
      - "8443:443"

    volumes:
      - ./nginx/nginx.pilot.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - kong
      - realtime-service
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # =====================
  # API Gateway (Kong)
  # =====================
  kong:
    image: kong:3.6
    container_name: govph-kong-pilot
    volumes:
      - ./gateway/kong.pilot.yml:/kong/declarative/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
    networks:
      - govph-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================
  # BFF – Citizen (Mobile)
  # =====================
  bff-citizen:
    build:
      context: .
      dockerfile: bff/bff-citizen/Dockerfile
    container_name: govph-bff-citizen-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: ${FIREBASE_SERVICE_ACCOUNT_KEY}
      FIREBASE_ADMIN_SDK_KEY: ${FIREBASE_ADMIN_SDK_KEY}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      IDENTITY_SERVICE_URL: http://govph-identity-pilot:3000
      GEO_SERVICE_URL: http://govph-geo-pilot:3000
      SOS_SERVICE_URL: http://govph-sos-pilot:3000
      REALTIME_SERVICE_URL: http://govph-realtime-pilot:3000
      INCIDENT_MS_URL: http://govph-incident-pilot:3000
      CLIENT_ID_ADMIN: ${CLIENT_ID_ADMIN}
      CLIENT_ID_RESCUE: ${CLIENT_ID_RESCUE}
      CITY_SERVICE_URL: http://govph-city-pilot:3000
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # BFF – Admin (Web)
  # =====================
  bff-admin:
    build:
      context: .
      dockerfile: bff/bff-admin/Dockerfile
    container_name: govph-bff-admin-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: ${FIREBASE_SERVICE_ACCOUNT_KEY}
      FIREBASE_ADMIN_SDK_KEY: ${FIREBASE_ADMIN_SDK_KEY}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      IDENTITY_SERVICE_URL: http://govph-identity-pilot:3000
      GEO_SERVICE_URL: http://govph-geo-pilot:3000
      SOS_SERVICE_URL: http://govph-sos-pilot:3000
      REALTIME_SERVICE_URL: http://govph-realtime-pilot:3000
      INCIDENT_MS_URL: http://govph-incident-pilot:3000
      CITY_SERVICE_URL: http://govph-city-pilot:3000
      CLIENT_ID_ADMIN: ${CLIENT_ID_ADMIN}
      CLIENT_ID_RESCUE: ${CLIENT_ID_RESCUE}
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # SOS Service
  # =====================
  sos-service:
    build: ./services/sos-service
    container_name: govph-sos-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      MICROSERVICE_NAME: sos-service-pilot
      REALTIME_SERVICE_URL: http://govph-realtime-pilot:3000
      IDENTITY_SERVICE_URL: http://govph-identity-pilot:3000
      MONGODB_URI: ${SOS_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${SOS_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${SOS_SERVICE_DB_NAME}

      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - realtime-service
      - identity-service

  # =====================
  # Identity Service
  # =====================
  identity-service:
    build: ./services/identity-service
    container_name: govph-identity-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      JWT_ACCESS_SECRET: ${JWT_ACCESS_SECRET}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      TOKEN_REVOCATION_ENABLED: ${TOKEN_REVOCATION_ENABLED}
      TOKEN_REVOCATION_CACHE_TTL: ${TOKEN_REVOCATION_CACHE_TTL}
      INVITE_LINK_HOST: ${INVITE_LINK_HOST}
      SEMAPHORE_API_KEY: ${SEMAPHORE_API_KEY}
      SEMAPHORE_API_URL: ${SEMAPHORE_API_URL}
      USER_SECRET: ${USER_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      OTP_SECRET: ${OTP_SECRET}
      MONGODB_URI: ${IDENTITY_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${IDENTITY_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${IDENTITY_SERVICE_DB_NAME}

    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # Geo Service
  # =====================
  geo-service:
    build: ./services/geo-service
    container_name: govph-geo-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      MICROSERVICE_NAME: geo-service-pilot
      CORS_ORIGIN: ${CORS_ORIGIN}
      MONGODB_URI: ${GEO_SERVICE_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${GEO_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${GEO_SERVICE_DB_NAME}

    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # Realtime Service
  # =====================
  realtime-service:
    build: ./services/realtime-service
    container_name: govph-realtime-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      REDIS_HOST: ${REDIS_HOST}
      REDIS_PORT: ${REDIS_PORT}
      REDIS_DB: ${REDIS_DB}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      SOS_MS_URL: http://govph-sos-pilot:3000
      CORS_ORIGIN: ${CORS_ORIGIN}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      SOS_SERVICE_URL: http://govph-sos-pilot:3000

    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # Incident Service
  # =====================
  incident-service:
    build: ./services/incident-service
    container_name: govph-incident-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      MONGODB_URI: ${INCIDENT_MONGODB_URI}
      MONGODB_URI_OPTIONS: ${INCIDENT_MONGODB_URI_OPTIONS}
      DB_NAME: ${INCIDENT_DB_NAME}
      IDENTITY_SERVICE_URL: http://govph-identity-pilot:3000
      LOG_LEVEL: ${LOG_LEVEL}
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # City Service
  # =====================
  city-service:
    build: ./services/city-service
    container_name: govph-city-pilot
    networks:
      - govph-network
    environment:
      NODE_ENV: pilot
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      MONGODB_URI: ${CITY_SERVICE_MONGODB_URI}
      CITY_SERVICE_URL: http://govph-city-pilot:3000
      MONGODB_URI_OPTIONS: ${CITY_SERVICE_MONGODB_URI_OPTIONS}
      DB_NAME: ${CITY_SERVICE_DB_NAME}
      MONGODB_POOL_SIZE: ${MONGODB_POOL_SIZE}
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  govph-network:
    driver: bridge
