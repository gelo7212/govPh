version: "3.9"

services:
  # =====================
  # NGINX Reverse Proxy
  # =====================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: govph-nginx-prod
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/letsencrypt:ro
    depends_on:
      - kong-citizen
      - kong-admin
      - realtime-service
    networks:
      - govph-network
    environment:
      NODE_ENV: production
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  # =====================
  # Kong Gateway – Citizen
  # =====================
  kong-citizen:
    image: kong:3.6
    container_name: govph-kong-citizen-prod
    volumes:
      - ./gateway/kong.citizen.prod.yml:/kong/declarative/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      JWT_SECRET: ${JWT_SECRET}
      KONG_LOG_LEVEL: warn
    networks:
      - govph-network
    restart: always
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================
  # Kong Gateway – Admin
  # =====================
  kong-admin:
    image: kong:3.6
    container_name: govph-kong-admin-prod
    volumes:
      - ./gateway/kong.admin.prod.yml:/kong/declarative/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
      JWT_SECRET: ${JWT_SECRET}
      KONG_LOG_LEVEL: warn
    networks:
      - govph-network
    restart: always
    healthcheck:
      test: ["CMD", "kong", "health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # =====================
  # BFF – Citizen (Mobile)
  # =====================
  bff-citizen:
    build:
      context: .
      dockerfile: bff/bff-citizen/Dockerfile
    container_name: govph-bff-citizen-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: ${FIREBASE_SERVICE_ACCOUNT_KEY}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      IDENTITY_SERVICE_URL: ${IDENTITY_SERVICE_URL}
      GEO_SERVICE_URL: ${GEO_SERVICE_URL}
      SOS_SERVICE_URL: ${SOS_SERVICE_URL}
      REALTIME_SERVICE_URL: ${REALTIME_SERVICE_URL}
      INCIDENT_MS_URL: ${INCIDENT_MS_URL}
      CLIENT_ID_ADMIN: ${CLIENT_ID_ADMIN}
      CLIENT_ID_RESCUE: ${CLIENT_ID_RESCUE}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # BFF – Admin (Web)
  # =====================
  bff-admin:
    build:
      context: .
      dockerfile: bff/bff-admin/Dockerfile
    container_name: govph-bff-admin-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      FIREBASE_SERVICE_ACCOUNT_KEY: ${FIREBASE_SERVICE_ACCOUNT_KEY}
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      IDENTITY_SERVICE_URL: ${IDENTITY_SERVICE_URL}
      GEO_SERVICE_URL: ${GEO_SERVICE_URL}
      SOS_SERVICE_URL: ${SOS_SERVICE_URL}
      REALTIME_SERVICE_URL: ${REALTIME_SERVICE_URL}
      INCIDENT_MS_URL: ${INCIDENT_MS_URL}
      CITY_SERVICE_URL: ${CITY_SERVICE_URL}
      CLIENT_ID_ADMIN: ${CLIENT_ID_ADMIN}
      CLIENT_ID_RESCUE: ${CLIENT_ID_RESCUE}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # SOS Service
  # =====================
  sos-service:
    build: ./services/sos-service
    container_name: govph-sos-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      MONGODB_URI: ${MONGODB_URI}
      REALTIME_SERVICE_URL: ${REALTIME_SERVICE_URL}
      IDENTITY_SERVICE_URL: ${IDENTITY_SERVICE_URL}
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      OPEN_MAPS_API_KEY: ${OPEN_MAPS_API_KEY}
      MAPBOX_API_KEY: ${MAPBOX_API_KEY}
      DEFAULT_MAP_PROVIDER: ${DEFAULT_MAP_PROVIDER}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - realtime-service
      - identity-service

  # =====================
  # Identity Service
  # =====================
  identity-service:
    build: ./services/identity-service
    container_name: govph-identity-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      SEMAPHORE_API_KEY: ${SEMAPHORE_API_KEY}
      USER_SECRET: ${USER_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      OTP_SECRET: ${OTP_SECRET}
      INVITE_LINK_HOST: ${INVITE_LINK_HOST}
      MONGODB_URI: ${MONGODB_URI}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # Geo Service
  # =====================
  geo-service:
    build: ./services/geo-service
    container_name: govph-geo-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      MONGODB_URI: ${MONGODB_URI}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # Realtime Service
  # =====================
  realtime-service:
    build: ./services/realtime-service
    container_name: govph-realtime-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      replicas: 3

  # =====================
  # Incident Service
  # =====================
  incident-service:
    build: ./services/incident-service
    container_name: govph-incident-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3004
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      MONGODB_URI: ${MONGODB_URI}
      IDENTITY_SERVICE_URL: ${IDENTITY_SERVICE_URL}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3004/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # =====================
  # City Service
  # =====================
  city-service:
    build: ./services/city-service
    container_name: govph-city-prod
    networks:
      - govph-network
    environment:
      NODE_ENV: production
      PORT: 3000
      INTERNAL_AUTH_TOKEN: ${INTERNAL_AUTH_TOKEN}
      MONGODB_URI: ${MONGODB_URI}
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  govph-network:
    driver: bridge
