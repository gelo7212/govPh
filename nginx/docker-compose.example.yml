# Docker Compose with Nginx Reverse Proxy
# Update your existing docker-compose.local.yml with this nginx service

version: '3.8'

services:
  # =====================
  # NGINX Reverse Proxy
  # =====================
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: govph-nginx
    ports:
      - "80:80"      # HTTP (redirects to HTTPS)
      - "443:443"    # HTTPS
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      # Uncomment below for production with Let's Encrypt
      # - ./certbot/conf:/etc/letsencrypt:ro
      # - ./certbot/www:/var/www/certbot:ro
    depends_on:
      - kong
      - realtime-service
    networks:
      - govph-network
    environment:
      NODE_ENV: local
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  kong:
    image: kong:3.6
    container_name: govph-kong
    volumes:
      - ./gateway/kong.local.yml:/kong/declarative/kong.yml
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong/declarative/kong.yml
    networks:
      - govph-network
    # Remove port mapping (access through nginx)
    # ports:
    #   - "8000:8000"

  # ... other services ...

  realtime-service:
    build: ./services/realtime-service
    container_name: govph-realtime
    networks:
      - govph-network
    # Remove port mapping (access through nginx)
    # ports:
    #   - "3005:3000"
    environment:
      PORT: 3000

networks:
  govph-network:
    driver: bridge
